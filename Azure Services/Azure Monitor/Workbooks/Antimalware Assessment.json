{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "** Author **\r\n[Bruno Gabrielli](mailto:bruno.gabrielli@microsoft.com)\r\n\r\n** Version 1.2 **\r\n2020-11-10\r\n- Added addition filter to only show workspaces with the AntiMalware solution deployed\r\n- Summarized the Server selection on VMUUID. To allow for devices with identical names. \r\n\r\n** Version 1.1 **\r\n2020-09-24\r\n- Added default selected value to Subscription, Workspace and Server parameters.\r\n\r\n** Version 1.0 **\r\n2020-06-17\r\n - Initial version\r\n\r\nReference link for ProtectionStatusRank and ThreatStatusRank:\r\n[http://diogenes63.rssing.com/chan-9384353/latest.php](http://diogenes63.rssing.com/chan-9384353/latest.php)"
      },
      "conditionalVisibility": {
        "parameterName": "_",
        "comparison": "isEqualTo",
        "value": "_"
      },
      "name": "text - 0"
    },
    {
      "type": 1,
      "content": {
        "json": "# Antimalware Assessment #"
      },
      "name": "text - 1"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "4288fdd0-f0bf-464f-8e5a-254b303a846b",
            "version": "KqlParameterItem/1.0",
            "name": "DefaultWorkspace",
            "type": 5,
            "isRequired": true,
            "value": "value::1",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.operationalinsights/workspaces": true
              },
              "additionalResourceOptions": [
                "value::1"
              ]
            }
          },
          {
            "id": "a46832ff-ac1b-4cad-a57b-bcb8c3e1bf0b",
            "version": "KqlParameterItem/1.0",
            "name": "ContextFree",
            "type": 1,
            "query": "{\"version\":\"1.0.0\",\"content\":\"\\\"{DefaultWorkspace}\\\"\",\"transformers\":null}",
            "isHiddenWhenLocked": true,
            "queryType": 8
          },
          {
            "id": "d882a725-07ff-48ea-8b7d-9210610c46e4",
            "version": "KqlParameterItem/1.0",
            "name": "Selection",
            "type": 1,
            "query": "where type =~ 'microsoft.operationalinsights/workspaces'\r\n| extend match = strcat(\"'\", id, \"'\") =~ \"{DefaultWorkspace:value}\"\r\n| order by match desc, name asc\r\n| take 1\r\n| project value = tostring(pack('sub', subscriptionId, 'rg', resourceGroup, 'ws', id))",
            "crossComponentResources": [
              "value::selected"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - 2"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "{Subscriptions}"
        ],
        "parameters": [
          {
            "id": "df4c53c0-b444-435e-a2f2-7fec0eec89a5",
            "version": "KqlParameterItem/1.0",
            "name": "Subscriptions",
            "type": 6,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "summarize by subscriptionId\r\n| project value = strcat('/subscriptions/', subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ todynamic('{Selection}').sub, true, false)",
            "crossComponentResources": [
              "value::selected"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "timeContextFromParameter": "TimeRange",
            "defaultValue": "value::all",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": []
          },
          {
            "id": "82e84d4b-6448-47fa-9b72-0ab45ab6cb86",
            "version": "KqlParameterItem/1.0",
            "name": "Workspaces",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "resources\r\n        | where type =~ \"microsoft.operationalinsights/workspaces\"\r\n| join kind=inner (\r\n    resources\r\n| where type =~ \"Microsoft.OperationsManagement/solutions\" and name contains \"AntiMalware\" )\r\non resourceGroup\r\n| project id",
            "crossComponentResources": [
              "{Subscriptions}"
            ],
            "value": [
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "timeContextFromParameter": "TimeRange",
            "defaultValue": "value::all",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "1a12e9e8-ce99-474a-bc8d-f256dca2fdda",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 604800000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            }
          },
          {
            "id": "fec8f562-fdfc-4ae5-b9c9-4e2de85ca35c",
            "version": "KqlParameterItem/1.0",
            "name": "Servers",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "ProtectionStatus\r\n| summarize by VMUUID,DeviceName\r\n| project DeviceName\r\n| order by DeviceName desc",
            "crossComponentResources": [
              "{Workspaces}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "defaultValue": "value::all",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "eb816ef5-bf7a-47bd-bbeb-82528e255f9d",
            "version": "KqlParameterItem/1.0",
            "name": "IsAntimalwareConfigured",
            "type": 2,
            "isRequired": true,
            "query": "ProtectionStatus\r\n| take 1\r\n| summarize count() ",
            "crossComponentResources": [
              "{Workspaces}"
            ],
            "value": null,
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          }
        ],
        "style": "pills",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "name": "parameters - 3"
    },
    {
      "type": 1,
      "content": {
        "json": "<br>\r\n### ⚠️  Data from Antimalware Assessment, which is necessary for this workbook to work properly, was not found in the selected workspace.\r\n---\r\n\r\nPlease select another workspace or check out the detailed documentation on how to collect Antimalware Assessment data in Azure Monitor at [this](https://azuremarketplace.microsoft.com/en-us/marketplace/apps/microsoft.antimalwareoms?tab=overview) link."
      },
      "conditionalVisibility": {
        "parameterName": "IsAntimalwareConfigured",
        "comparison": "isEqualTo",
        "value": "0"
      },
      "name": "AntimalwareNotConfigured"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "ProtectionStatus\r\n| where Computer in ({Servers})\r\n| summarize arg_max(TimeGenerated,*) by Computer\r\n| summarize dcount(Computer) by TypeofProtection",
        "size": 1,
        "showAnalytics": true,
        "title": "Protection by product.",
        "noDataMessage": "No data for the selected conditions.",
        "timeContext": {
          "durationMs": 14400000
        },
        "timeContextFromParameter": "TimeRange",
        "showExportToExcel": true,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{Workspaces}"
        ],
        "visualization": "piechart"
      },
      "conditionalVisibility": {
        "parameterName": "IsAntimalwareConfigured",
        "comparison": "isNotEqualTo",
        "value": "0"
      },
      "showPin": true,
      "name": "ProtectionByTypeofProtection",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "ProtectionStatus\r\n| where Computer in ({Servers})\r\n| summarize arg_max(TimeGenerated, *) by Computer\r\n| summarize dcount(Computer) by ProtectionStatus",
        "size": 1,
        "showAnalytics": true,
        "title": "Protection by protection status.",
        "noDataMessage": "No data for the selected conditions.",
        "timeContext": {
          "durationMs": 14400000
        },
        "timeContextFromParameter": "TimeRange",
        "showExportToExcel": true,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{Workspaces}"
        ],
        "visualization": "piechart",
        "chartSettings": {
          "seriesLabelSettings": [
            {
              "seriesName": "No real time protection",
              "color": "redBright"
            },
            {
              "seriesName": "Real time protection",
              "color": "green"
            },
            {
              "seriesName": "Not Reporting",
              "color": "gray"
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "IsAntimalwareConfigured",
        "comparison": "isNotEqualTo",
        "value": "0"
      },
      "showPin": true,
      "name": "ProtectionByProtectionStatus",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "7a9cfaf9-d703-499e-9e0f-74411c8510e2",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Unprotected Computers",
            "subTarget": "Unprotected",
            "style": "link"
          },
          {
            "id": "33f2031b-be13-4185-92f0-f87097eacc49",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Protected Computers",
            "subTarget": "Protected",
            "style": "link"
          },
          {
            "id": "b97e913f-2396-4833-ac3d-0f3a6d10bd39",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Threated Computers",
            "subTarget": "Threated",
            "style": "link"
          },
          {
            "id": "19f5c1cd-fc86-4310-95da-07ece7842cae",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Not Reporting Computers",
            "subTarget": "NotReporting",
            "style": "link"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "IsAntimalwareConfigured",
        "comparison": "isNotEqualTo",
        "value": "0"
      },
      "name": "Tabs"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "ProtectionStatus\r\n| where Computer in ({Servers})\r\n| summarize arg_max(TimeGenerated, *) by Computer\r\n| where TypeofProtection == \"No Anti-Malware Tool was detected\"\r\n| project Computer, SourceComputerId, ProtectionStatusRank, pr=ProtectionStatus //pr=\"Rank\"",
              "size": 0,
              "showAnalytics": true,
              "title": "Computer(s) with no protection detected.",
              "noDataMessage": "No unprotected computers within the selected conditions.",
              "timeContext": {
                "durationMs": 14400000
              },
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "SourceComputerId",
              "exportParameterName": "SourceComputerId",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspaces}"
              ],
              "visualization": "tiles",
              "gridSettings": {
                "filter": true
              },
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Computer",
                  "formatter": 2,
                  "formatOptions": {
                    "showIcon": true
                  },
                  "tooltipFormat": {
                    "tooltip": "Click on the tile to see more details."
                  }
                },
                "leftContent": {
                  "columnMatch": "ProtectionStatusRank",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto",
                    "showIcon": true
                  },
                  "tooltipFormat": {
                    "tooltip": "Click on the tile to see more details."
                  }
                },
                "rightContent": {
                  "columnMatch": "pr",
                  "formatOptions": {
                    "showIcon": true
                  },
                  "tooltipFormat": {
                    "tooltip": "Click on the tile to see more details."
                  }
                },
                "showBorder": true
              }
            },
            "showPin": true,
            "name": "UnprotectedComputers",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "ProtectionStatus\r\n| where SourceComputerId == tostring(\"{SourceComputerId}\")\r\n| summarize arg_max(TimeGenerated, *) by Computer\r\n| where TypeofProtection == \"No Anti-Malware Tool was detected\"\r\n| project TimeGenerated, Computer, TypeofProtection\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Selected computer with no protection detected - details.",
              "noDataMessage": "No unprotected computers within the selected conditions.",
              "timeContext": {
                "durationMs": 14400000
              },
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspaces}"
              ]
            },
            "conditionalVisibility": {
              "parameterName": "SourceComputerId",
              "comparison": "isNotEqualTo"
            },
            "name": "SelectedUnprotectedComputersDetail",
            "styleSettings": {
              "showBorder": true
            }
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "selectedTab",
          "comparison": "isEqualTo",
          "value": "Unprotected"
        },
        {
          "parameterName": "IsAntimalwareConfigured",
          "comparison": "isNotEqualTo",
          "value": "0"
        }
      ],
      "name": "UnprotectedGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "tabs",
              "links": [
                {
                  "id": "9de2a451-194a-419b-b650-d017fbd99f5e",
                  "cellValue": "selectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Fully Protected",
                  "subTarget": "FullyProtected",
                  "style": "link"
                },
                {
                  "id": "8743b3fc-e7c4-4f23-a556-5583495b3bbb",
                  "cellValue": "selectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Protected with issues",
                  "subTarget": "PartiallyProtected",
                  "style": "link"
                },
                {
                  "id": "72156e25-87bf-433c-982b-ef789cee1fbf",
                  "cellValue": "selectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Scan & Signature issues",
                  "subTarget": "ScanSignatureIssue",
                  "style": "link"
                }
              ]
            },
            "name": "Tabs_2"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "ProtectionStatus\r\n| where Computer in ({Servers})\r\n| summarize arg_max(TimeGenerated, *) by SourceComputerId\r\n| where ProtectionStatusRank == 150\r\n| project TypeofProtection, AMProductVersion, TimeGenerated, Computer, SignatureVersion, ScanDate\r\n| order by Computer asc",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Protected Computers By Product",
                    "timeContext": {
                      "durationMs": 14400000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspaces}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "TypeofProtection",
                          "formatter": 5,
                          "formatOptions": {}
                        },
                        {
                          "columnMatch": "Computer",
                          "formatter": 1,
                          "formatOptions": {
                            "linkTarget": "GenericDetails",
                            "linkIsContextBlade": true
                          },
                          "tooltipFormat": {
                            "tooltip": "Click here to see more details."
                          }
                        },
                        {
                          "columnMatch": "SignatureVersion",
                          "formatter": 5,
                          "formatOptions": {}
                        },
                        {
                          "columnMatch": "ScanDate",
                          "formatter": 5,
                          "formatOptions": {}
                        }
                      ],
                      "hierarchySettings": {
                        "treeType": 1,
                        "groupBy": [
                          "TypeofProtection"
                        ],
                        "expandTopLevel": true
                      },
                      "sortBy": [
                        {
                          "itemKey": "TimeGenerated",
                          "sortOrder": 1
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "TypeofProtection",
                          "label": "Protected By"
                        },
                        {
                          "columnId": "AMProductVersion",
                          "label": "Version"
                        },
                        {
                          "columnId": "TimeGenerated",
                          "label": "Time Generated"
                        },
                        {
                          "columnId": "Computer"
                        },
                        {
                          "columnId": "SignatureVersion",
                          "label": "Signature Version"
                        },
                        {
                          "columnId": "ScanDate",
                          "label": "Last Scan"
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "TimeGenerated",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "showPin": true,
                  "name": "ProtectedComputersByProduct",
                  "styleSettings": {
                    "showBorder": true
                  }
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "selectedTab",
              "comparison": "isEqualTo",
              "value": "FullyProtected"
            },
            "name": "FullyProtectedGroup"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "ProtectionStatus\r\n| where Computer in ({Servers})\r\n| summarize arg_max(TimeGenerated, *) by SourceComputerId\r\n| where TypeofProtection != \"No Anti-Malware Tool was detected\"\r\n| where ProtectionStatusRank !in (150, 550)\r\n| project Computer, SourceComputerId, ProtectionStatusRank, pr=ProtectionStatus //pr=\"Rank\"",
                    "size": 1,
                    "showAnalytics": true,
                    "title": "Computer(s) with insufficient protection",
                    "noDataMessage": "No computers with insufficient oritection detected within the selected conditions.",
                    "timeContext": {
                      "durationMs": 14400000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "exportFieldName": "SourceComputerId",
                    "exportParameterName": "row",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspaces}"
                    ],
                    "visualization": "tiles",
                    "gridSettings": {
                      "filter": true
                    },
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Computer",
                        "formatter": 1,
                        "formatOptions": {
                          "showIcon": true
                        },
                        "tooltipFormat": {
                          "tooltip": "Click on the tile to see more details."
                        }
                      },
                      "leftContent": {
                        "columnMatch": "ProtectionStatusRank",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto",
                          "showIcon": true
                        },
                        "tooltipFormat": {
                          "tooltip": "Click on the tile to see more details."
                        }
                      },
                      "rightContent": {
                        "columnMatch": "pr",
                        "formatOptions": {
                          "showIcon": true
                        },
                        "tooltipFormat": {
                          "tooltip": "Click on the tile to see more details."
                        }
                      },
                      "showBorder": true,
                      "sortCriteriaField": "Computer",
                      "sortOrderField": 1
                    }
                  },
                  "showPin": true,
                  "name": "ComputerWithInsufficientProtection"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "ProtectionStatus\r\n| where SourceComputerId == tostring(\"{row}\")\r\n| summarize arg_max(TimeGenerated, *)\r\n| where TypeofProtection != \"No Anti-Malware Tool was detected\"\r\n| where ProtectionStatusRank !in (150, 550)\r\n| project TimeGenerated, Computer, TypeofProtection, ProdVer=AMProductVersion, SignatureVersion, ProtectionStatusRank, ProtectionStatus, ProtectionStatusDetails, TenantId",
                    "size": 0,
                    "title": "Insufficient protection details by selected computer",
                    "timeContext": {
                      "durationMs": 14400000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspaces}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Computer",
                          "formatter": 1,
                          "formatOptions": {
                            "linkTarget": "GenericDetails",
                            "linkIsContextBlade": true
                          },
                          "tooltipFormat": {
                            "tooltip": "Click here to see more details."
                          }
                        },
                        {
                          "columnMatch": "ProdVer",
                          "formatter": 5,
                          "formatOptions": {}
                        },
                        {
                          "columnMatch": "SignatureVersion",
                          "formatter": 5,
                          "formatOptions": {}
                        },
                        {
                          "columnMatch": "ProtectionStatus",
                          "formatter": 5,
                          "formatOptions": {}
                        },
                        {
                          "columnMatch": "TenantId",
                          "formatter": 5,
                          "formatOptions": {}
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "TimeGenerated",
                          "label": "Time Generated"
                        },
                        {
                          "columnId": "Computer"
                        },
                        {
                          "columnId": "TypeofProtection",
                          "label": "Protected By"
                        },
                        {
                          "columnId": "ProdVer",
                          "label": "Version"
                        },
                        {
                          "columnId": "SignatureVersion",
                          "label": "Signature Version"
                        },
                        {
                          "columnId": "ProtectionStatusRank",
                          "label": "Protection Rank"
                        },
                        {
                          "columnId": "ProtectionStatus",
                          "label": "Protection Status"
                        },
                        {
                          "columnId": "ProtectionStatusDetails",
                          "label": "Protection Status Details"
                        },
                        {
                          "columnId": "TenantId"
                        }
                      ]
                    }
                  },
                  "conditionalVisibility": {
                    "parameterName": "row",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "InsufficientProtectionDetailBySelectedComputer",
                  "styleSettings": {
                    "showBorder": true
                  }
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "selectedTab",
              "comparison": "isEqualTo",
              "value": "PartiallyProtected"
            },
            "name": "PartiallyProtectedGroup"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "69bbf8c9-88c4-4c8d-8222-05a61b122e50",
                        "version": "KqlParameterItem/1.0",
                        "name": "ScanOldness",
                        "label": "Last scan (<= # days)",
                        "type": 2,
                        "value": "0",
                        "typeSettings": {
                          "additionalResourceOptions": []
                        },
                        "jsonData": "[1,2,3,4,5,6,7,8,9,0]",
                        "timeContext": {
                          "durationMs": 1209600000
                        },
                        "timeContextFromParameter": "TimeRange"
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "parameters - 0"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let filterScanOldness = strcat(iif(\"{ScanOldness}\"==\"\", dynamic('0'), dynamic('{ScanOldness}')),\".0:00:00.0\");\r\nlet scanOldnessValue = iif(\"{ScanOldness}\"==\"\", dynamic('0'), dynamic('{ScanOldness}'));\r\nProtectionStatus\r\n| where Computer in ({Servers})\r\n| summarize arg_max(TimeGenerated, *) by SourceComputerId\r\n| where ScanDate <= ago(totimespan(filterScanOldness))\r\n| project TimeGenerated, Computer, ProtectionStatusRank, ProtectionStatus, ProtectionStatusDetails, ScanDate, scanOldnessValue\r\n| sort by TimeGenerated desc",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Last scan information.",
                    "noDataMessage": "No computers with last scan date older than the selected number of days.",
                    "timeContext": {
                      "durationMs": 14400000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspaces}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Computer",
                          "formatter": 1,
                          "formatOptions": {
                            "linkTarget": "GenericDetails",
                            "linkIsContextBlade": true
                          },
                          "tooltipFormat": {
                            "tooltip": "Click here to see more details."
                          }
                        },
                        {
                          "columnMatch": "ProtectionStatusRank",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "ProtectionStatus",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "ProtectionStatusDetails",
                          "formatter": 5
                        }
                      ],
                      "filter": true,
                      "labelSettings": [
                        {
                          "columnId": "TimeGenerated",
                          "label": "Time Generated"
                        },
                        {
                          "columnId": "Computer"
                        },
                        {
                          "columnId": "ProtectionStatusRank",
                          "label": "Protection Rank"
                        },
                        {
                          "columnId": "ProtectionStatus",
                          "label": "Protection Status"
                        },
                        {
                          "columnId": "ProtectionStatusDetails",
                          "label": "Protection Status Details"
                        },
                        {
                          "columnId": "ScanDate",
                          "label": "Last scan date"
                        },
                        {
                          "columnId": "scanOldnessValue",
                          "label": "Signature Oldness"
                        }
                      ]
                    }
                  },
                  "showPin": true,
                  "name": "LastScanInformation",
                  "styleSettings": {
                    "showBorder": true
                  }
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "5cf482be-ea87-4b4a-a011-d7f9b75c2342",
                        "version": "KqlParameterItem/1.0",
                        "name": "SignatureOldness",
                        "label": "Last signature update (<= # days)",
                        "type": 2,
                        "value": "0",
                        "typeSettings": {
                          "additionalResourceOptions": []
                        },
                        "jsonData": "[1,2,3,4,5,6,7,8,9,0]",
                        "timeContext": {
                          "durationMs": 1209600000
                        },
                        "timeContextFromParameter": "TimeRange"
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "parameters - 3"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let filterSignatures = iif(\"{SignatureOldness}\"==\"\", dynamic('0'), dynamic('{SignatureOldness}'));\r\nlet signUpdated = ProtectionStatus\r\n| where Computer in ({Servers})\r\n| summarize arg_max(TimeGenerated, *) by SourceComputerId\r\n| where ProtectionStatusRank == 150\r\n| where ProtectionStatusDetails startswith \"AntivirusSignatureLastUpdated\"\r\n| extend signatureLastUpdated = trim_start(\"AntivirusSignatureLastUpdated: \",ProtectionStatusDetails)\r\n| extend daysOld = datetime_diff('Day',TimeGenerated,todatetime(signatureLastUpdated))\r\n| where daysOld >= filterSignatures;\r\nlet signNotUpdated = ProtectionStatus\r\n| where Computer in ({Servers})\r\n| summarize arg_max(TimeGenerated, *) by SourceComputerId\r\n| where ProtectionStatusRank == 270\r\n| extend signatureLastUpdated = \"Not available\";\r\nsignUpdated\r\n| union kind=outer signNotUpdated\r\n| project TimeGenerated, Computer, TypeofProtection, AMProductVersion , SignatureVersion, signatureLastUpdated, daysOld\r\n| sort by TimeGenerated desc",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Signature information",
                    "noDataMessage": "No computers with signature older than the selected number of days.",
                    "timeContext": {
                      "durationMs": 14400000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspaces}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Computer",
                          "formatter": 1,
                          "formatOptions": {
                            "linkTarget": "GenericDetails",
                            "linkIsContextBlade": true
                          },
                          "tooltipFormat": {
                            "tooltip": "Click here to see more details."
                          }
                        },
                        {
                          "columnMatch": "TypeofProtection",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "AMProductVersion",
                          "formatter": 5
                        }
                      ],
                      "filter": true,
                      "labelSettings": [
                        {
                          "columnId": "TimeGenerated",
                          "label": "Time Generated"
                        },
                        {
                          "columnId": "Computer"
                        },
                        {
                          "columnId": "TypeofProtection",
                          "label": "Protected By"
                        },
                        {
                          "columnId": "AMProductVersion",
                          "label": "Version"
                        },
                        {
                          "columnId": "SignatureVersion",
                          "label": "Signature Version"
                        },
                        {
                          "columnId": "signatureLastUpdated",
                          "label": "Signature Last Updated"
                        },
                        {
                          "columnId": "daysOld",
                          "label": "# of days old"
                        }
                      ]
                    }
                  },
                  "showPin": true,
                  "name": "OutdatedSignature",
                  "styleSettings": {
                    "showBorder": true
                  }
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "selectedTab",
              "comparison": "isEqualTo",
              "value": "ScanSignatureIssue"
            },
            "name": "ScanSignatureIssueGroup"
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "selectedTab",
          "comparison": "isEqualTo",
          "value": "Protected"
        },
        {
          "parameterName": "IsAntimalwareConfigured",
          "comparison": "isNotEqualTo",
          "value": "0"
        }
      ],
      "name": "ProtectedGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "ProtectionStatus\r\n| where Computer in ({Servers})\r\n| summarize arg_max(TimeGenerated,*) by Computer\r\n| where ProtectionStatusRank == 550\r\n| where ThreatStatusRank == 550\r\n| summarize ComputersCount=dcount(Computer) by Threat\r\n| sort by ComputersCount desc",
              "size": 0,
              "title": "Computers by active threats",
              "noDataMessage": "No threated computers within the selected conditions.",
              "timeContext": {
                "durationMs": 1209600000
              },
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspaces}"
              ],
              "visualization": "barchart"
            },
            "showPin": true,
            "name": "ComputersByActiveThreats",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "ProtectionStatus\r\n| where Computer in ({Servers})\r\n| summarize arg_max(TimeGenerated,*) by Computer\r\n| where ProtectionStatusRank == 550\r\n| where ThreatStatusRank == 550\r\n| project TimeGenerated, Computer, ThreatStatusRank, Threat, ThreatStatus, ThreatStatusDetails, ProtectionStatus, ProtectionStatusDetails",
              "size": 0,
              "showAnalytics": true,
              "title": "Computers by active threats - Details",
              "noDataMessage": "No threated computers within the selected conditions.",
              "timeContext": {
                "durationMs": 1209600000
              },
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspaces}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Computer",
                    "formatter": 1,
                    "formatOptions": {
                      "linkTarget": "GenericDetails",
                      "linkIsContextBlade": true
                    },
                    "tooltipFormat": {
                      "tooltip": "Click here to see more details."
                    }
                  },
                  {
                    "columnMatch": "ProtectionStatus",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "ProtectionStatusDetails",
                    "formatter": 5
                  }
                ],
                "filter": true,
                "labelSettings": [
                  {
                    "columnId": "TimeGenerated",
                    "label": "Time Generated"
                  },
                  {
                    "columnId": "Computer"
                  },
                  {
                    "columnId": "ThreatStatusRank",
                    "label": "Threat Status Rank"
                  },
                  {
                    "columnId": "Threat"
                  },
                  {
                    "columnId": "ThreatStatus",
                    "label": "Threat Status"
                  },
                  {
                    "columnId": "ThreatStatusDetails",
                    "label": "Threat Status Details"
                  },
                  {
                    "columnId": "ProtectionStatus",
                    "label": "Protection Status"
                  },
                  {
                    "columnId": "ProtectionStatusDetails",
                    "label": "Protection Status Details"
                  }
                ]
              }
            },
            "showPin": true,
            "name": "ComputersByActiveThreatsDetails",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "ProtectionStatus\r\n| where Computer in ({Servers})\r\n| summarize arg_max(TimeGenerated,*) by Computer\r\n| where ProtectionStatusRank == 550 //350\r\n| where ThreatStatusRank == 350\r\n| project TimeGenerated, Computer, ThreatStatusRank, Threat, ThreatStatus",
              "size": 0,
              "showAnalytics": true,
              "title": "Quarantined Computers",
              "noDataMessage": "No quarantined computers within the selected conditions.",
              "timeContext": {
                "durationMs": 1209600000
              },
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspaces}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Computer",
                    "formatter": 1,
                    "formatOptions": {
                      "linkTarget": "GenericDetails",
                      "linkIsContextBlade": true
                    },
                    "tooltipFormat": {
                      "tooltip": "Click here to see more details."
                    }
                  },
                  {
                    "columnMatch": "ProtectionStatus",
                    "formatter": 5,
                    "formatOptions": {}
                  },
                  {
                    "columnMatch": "ProtectionStatusDetails",
                    "formatter": 5,
                    "formatOptions": {}
                  }
                ],
                "filter": true,
                "labelSettings": [
                  {
                    "columnId": "TimeGenerated",
                    "label": "Time Generated"
                  },
                  {
                    "columnId": "Computer"
                  },
                  {
                    "columnId": "ThreatStatusRank",
                    "label": "Threat Status Rank"
                  },
                  {
                    "columnId": "ThreatStatus",
                    "label": "Threat Status"
                  },
                  {
                    "columnId": "ProtectionStatus",
                    "label": "Protection Status"
                  },
                  {
                    "columnId": "ProtectionStatusDetails",
                    "label": "Protection Status Details"
                  }
                ]
              }
            },
            "showPin": true,
            "name": "QuarantinedComputers",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "ProtectionStatus\r\n| where Computer in ({Servers})\r\n| summarize arg_max(TimeGenerated,*) by Computer\r\n| where ProtectionStatusRank == 550 //370\r\n| where ThreatStatusRank == 370\r\n| project TimeGenerated, Computer, ThreatStatusRank, Threat, ThreatStatus, ThreatStatusDetails",
              "size": 0,
              "showAnalytics": true,
              "title": "Computers with remediated threats",
              "noDataMessage": "No computers wit h remediated threats within the selected conditions.",
              "timeContext": {
                "durationMs": 1209600000
              },
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspaces}"
              ],
              "gridSettings": {
                "filter": true,
                "labelSettings": [
                  {
                    "columnId": "TimeGenerated",
                    "label": "Time Generated"
                  },
                  {
                    "columnId": "Computer"
                  },
                  {
                    "columnId": "ThreatStatusRank",
                    "label": "Threat Status Rank"
                  },
                  {
                    "columnId": "Threat"
                  },
                  {
                    "columnId": "ThreatStatus",
                    "label": "Threat Status"
                  },
                  {
                    "columnId": "ThreatStatusDetails",
                    "label": "Threat Status Details"
                  }
                ]
              }
            },
            "name": "RemediatedComputers",
            "styleSettings": {
              "showBorder": true
            }
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "selectedTab",
          "comparison": "isEqualTo",
          "value": "Threated"
        },
        {
          "parameterName": "IsAntimalwareConfigured",
          "comparison": "isNotEqualTo",
          "value": "0"
        }
      ],
      "name": "ThreatedGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "ProtectionStatus\r\n| where Computer in ({Servers})\r\n| summarize arg_max(TimeGenerated, *) by Computer\r\n| where ProtectionStatus == \"Not Reporting\"\r\n| project TimeGenerated, Computer, ProtectionStatus, ProtectionStatusDetails\r\n",
              "size": 0,
              "title": "Computers which are not reporting",
              "noDataMessage": "No computers which are not reporting within the selected conditions.",
              "timeContext": {
                "durationMs": 1209600000
              },
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspaces}"
              ],
              "gridSettings": {
                "filter": true,
                "labelSettings": [
                  {
                    "columnId": "TimeGenerated",
                    "label": "Time Generated"
                  },
                  {
                    "columnId": "Computer"
                  },
                  {
                    "columnId": "ProtectionStatus",
                    "label": "Protection Status"
                  },
                  {
                    "columnId": "ProtectionStatusDetails",
                    "label": "Protection Status Details"
                  }
                ]
              }
            },
            "name": "NotReportingComputers",
            "styleSettings": {
              "showBorder": true
            }
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "selectedTab",
          "comparison": "isEqualTo",
          "value": "NotReporting"
        },
        {
          "parameterName": "IsAntimalwareConfigured",
          "comparison": "isNotEqualTo",
          "value": "0"
        }
      ],
      "name": "NotReportingGroup"
    }
  ],
  "fallbackResourceIds": [
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
